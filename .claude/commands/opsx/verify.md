---
name: "OPSX: 検証"
description: アーカイブ前に実装が変更アーティファクトと一致しているか検証
category: Workflow
tags: [workflow, verify, experimental]
---

実装が変更アーティファクト（specs、tasks、design）と一致しているか検証します。

**入力**: `/opsx:verify`の後にオプションで変更名を指定（例：`/opsx:verify add-auth`）。省略した場合は会話のコンテキストから推測を試みます。曖昧または不明確な場合は、利用可能な変更を表示して選択を促す必要があります。

**手順**

1. **変更名が指定されていない場合、選択を促す**

   `openspec list --json`を実行して利用可能な変更を取得。**AskUserQuestionツール**を使用してユーザーに選択させます。

   実装タスクがある変更（tasksアーティファクトが存在）を表示。
   各変更に使用されているスキーマがあれば含める。
   未完了タスクがある変更には「（進行中）」マークを付ける。

   **重要**: 推測や自動選択をしない。必ずユーザーに選択させる。

2. **状態を確認してスキーマを理解**
   ```bash
   openspec status --change "<name>" --json
   ```
   JSONをパースして理解：
   - `schemaName`: 使用中のワークフロー（例：「spec-driven」）
   - この変更に存在するアーティファクト

3. **変更ディレクトリを取得しアーティファクトをロード**

   ```bash
   openspec instructions apply --change "<name>" --json
   ```

   変更ディレクトリとコンテキストファイルが返される。`contextFiles`から利用可能なすべてのアーティファクトを読む。

4. **検証レポート構造を初期化**

   3つの次元でレポート構造を作成：
   - **完全性**: タスクとspecカバレッジを追跡
   - **正確性**: 要件実装とシナリオカバレッジを追跡
   - **一貫性**: 設計準拠とパターン一貫性を追跡

   各次元にはCRITICAL、WARNING、SUGGESTIONの問題がある可能性。

5. **完全性を検証**

   **タスク完了**:
   - contextFilesにtasks.mdがあれば読む
   - チェックボックスをパース：`- [ ]`（未完了）vs `- [x]`（完了）
   - 完了vs合計タスクをカウント
   - 未完了タスクがある場合：
     - 各未完了タスクにCRITICAL問題を追加
     - 推奨：「タスクを完了: <説明>」または「既に実装済みなら完了にマーク」

   **Specカバレッジ**:
   - `openspec/changes/<name>/specs/`にデルタspecsがある場合：
     - すべての要件を抽出（「### Requirement:」マーク）
     - 各要件に対して：
       - 要件に関連するキーワードでコードベースを検索
       - 実装が存在しそうか評価
     - 要件が未実装に見える場合：
       - CRITICAL問題を追加：「要件が見つからない: <要件名>」
       - 推奨：「要件Xを実装: <説明>」

6. **正確性を検証**

   **要件実装マッピング**:
   - デルタspecsの各要件に対して：
     - 実装の証拠をコードベースで検索
     - 見つかった場合、ファイルパスと行範囲をメモ
     - 実装が要件の意図と一致しているか評価
     - 乖離が検出された場合：
       - WARNING追加：「実装がspecと乖離している可能性: <詳細>」
       - 推奨：「要件Xに対して<ファイル>:<行>をレビュー」

   **シナリオカバレッジ**:
   - デルタspecsの各シナリオに対して（「#### Scenario:」マーク）：
     - 条件がコードで処理されているか確認
     - シナリオをカバーするテストが存在するか確認
     - シナリオがカバーされていない場合：
       - WARNING追加：「シナリオがカバーされていない: <シナリオ名>」
       - 推奨：「シナリオのテストまたは実装を追加: <説明>」

7. **一貫性を検証**

   **設計準拠**:
   - contextFilesにdesign.mdがある場合：
     - 主要な決定を抽出（「Decision:」、「Approach:」、「Architecture:」セクションを探す）
     - 実装がそれらの決定に従っているか確認
     - 矛盾が検出された場合：
       - WARNING追加：「設計決定に従っていない: <決定>」
       - 推奨：「実装を更新するか、design.mdを現実に合わせて修正」
   - design.mdがない場合：設計準拠チェックをスキップ、「検証対象のdesign.mdがありません」とメモ

   **コードパターン一貫性**:
   - 新しいコードがプロジェクトパターンと一致しているかレビュー
   - ファイル命名、ディレクトリ構造、コーディングスタイルをチェック
   - 重大な逸脱が見つかった場合：
     - SUGGESTION追加：「コードパターンの逸脱: <詳細>」
     - 推奨：「プロジェクトパターンに従うことを検討: <例>」

8. **検証レポートを生成**

   **サマリースコアカード**:
   ```
   ## 検証レポート: <change-name>

   ### サマリー
   | 次元     | 状態              |
   |----------|-------------------|
   | 完全性   | X/Y タスク, N 要件 |
   | 正確性   | M/N 要件カバー    |
   | 一貫性   | 準拠/問題あり     |
   ```

   **優先度別の問題**:

   1. **CRITICAL**（アーカイブ前に修正必須）:
      - 未完了タスク
      - 未実装の要件
      - それぞれ具体的でアクション可能な推奨付き

   2. **WARNING**（修正すべき）:
      - Spec/設計の乖離
      - シナリオカバレッジの欠如
      - それぞれ具体的な推奨付き

   3. **SUGGESTION**（修正すると良い）:
      - パターンの不整合
      - 軽微な改善
      - それぞれ具体的な推奨付き

   **最終評価**:
   - CRITICAL問題がある場合：「X件のクリティカルな問題があります。アーカイブ前に修正してください。」
   - WARNINGのみの場合：「クリティカルな問題はありません。Y件の警告を検討してください。アーカイブ可能です（改善点あり）。」
   - すべてクリアの場合：「すべてのチェックに合格。アーカイブ準備完了。」

**検証ヒューリスティック**

- **完全性**: 客観的なチェックリスト項目に焦点（チェックボックス、要件リスト）
- **正確性**: キーワード検索、ファイルパス分析、合理的な推論を使用 - 完璧な確実性は不要
- **一貫性**: 明らかな不整合を探す、スタイルを細かく指摘しない
- **誤検出**: 不確かな場合はWARNINGよりSUGGESTION、CRITICALよりWARNINGを優先
- **アクション可能性**: すべての問題には該当する場合ファイル/行参照付きの具体的な推奨が必要

**グレースフルデグラデーション**

- tasks.mdのみ存在：タスク完了のみ検証、spec/設計チェックをスキップ
- tasks + specsが存在：完全性と正確性を検証、設計をスキップ
- 完全なアーティファクト：3つの次元すべてを検証
- スキップしたチェックとその理由を常にメモ

**出力フォーマット**

明確なマークダウンを使用：
- サマリースコアカードにテーブル
- 問題をグループ化したリスト（CRITICAL/WARNING/SUGGESTION）
- コード参照は`file.ts:123`形式
- 具体的でアクション可能な推奨
- 「レビューを検討してください」のような曖昧な提案は避ける
