---
name: "OPSX: アーカイブ"
description: 実験的ワークフローで完了した変更をアーカイブ
category: Workflow
tags: [workflow, archive, experimental]
---

実験的ワークフローで完了した変更をアーカイブします。

**入力**: `/opsx:archive`の後にオプションで変更名を指定（例：`/opsx:archive add-auth`）。省略した場合は会話のコンテキストから推測を試みます。曖昧または不明確な場合は、利用可能な変更を表示して選択を促す必要があります。

**手順**

1. **変更名が指定されていない場合、選択を促す**

   `openspec list --json`を実行して利用可能な変更を取得。**AskUserQuestionツール**を使用してユーザーに選択させます。

   アクティブな変更のみ表示（既にアーカイブ済みでないもの）。
   各変更に使用されているスキーマがあれば含める。

   **重要**: 推測や自動選択をしない。必ずユーザーに選択させる。

2. **アーティファクト完了状態を確認**

   `openspec status --change "<name>" --json`を実行してアーティファクトの完了を確認。

   JSONをパースして理解：
   - `schemaName`: 使用中のワークフロー
   - `artifacts`: 各アーティファクトとその状態（`done`または他）のリスト

   **`done`でないアーティファクトがある場合:**
   - 未完了アーティファクトのリストを警告表示
   - 続行するかユーザーに確認を促す
   - ユーザーが確認したら続行

3. **タスク完了状態を確認**

   タスクファイル（通常`tasks.md`）を読んで未完了タスクを確認。

   `- [ ]`（未完了）vs `- [x]`（完了）でマークされたタスクをカウント。

   **未完了タスクがある場合:**
   - 未完了タスク数を警告表示
   - 続行するかユーザーに確認を促す
   - ユーザーが確認したら続行

   **タスクファイルがない場合:** タスク関連の警告なしで続行。

4. **デルタspec同期状態を評価**

   `openspec/changes/<name>/specs/`にデルタspecsがあるか確認。なければ同期プロンプトなしで続行。

   **デルタspecsがある場合:**
   - 各デルタspecを`openspec/specs/<capability>/spec.md`の対応するメインspecと比較
   - 適用される変更を判断（追加、変更、削除、名前変更）
   - プロンプト前に統合サマリーを表示

   **プロンプトオプション:**
   - 変更が必要な場合：「今すぐ同期（推奨）」、「同期せずにアーカイブ」
   - 既に同期済みの場合：「今すぐアーカイブ」、「とにかく同期」、「キャンセル」

   ユーザーが同期を選んだ場合、`/opsx:sync`ロジックを実行。選択に関係なくアーカイブに進む。

5. **アーカイブを実行**

   アーカイブディレクトリがなければ作成：
   ```bash
   mkdir -p openspec/changes/archive
   ```

   現在の日付でターゲット名を生成：`YYYY-MM-DD-<change-name>`

   **ターゲットが既に存在するか確認:**
   - 存在する場合：エラーで失敗、既存アーカイブの名前変更または別の日付の使用を提案
   - 存在しない場合：変更ディレクトリをアーカイブに移動

   ```bash
   mv openspec/changes/<name> openspec/changes/archive/YYYY-MM-DD-<name>
   ```

6. **サマリーを表示**

   アーカイブ完了サマリーを表示：
   - 変更名
   - 使用されたスキーマ
   - アーカイブ場所
   - Spec同期状態（同期済み/同期スキップ/デルタspecなし）
   - 警告があればメモ（未完了アーティファクト/タスク）

**成功時の出力**

```
## アーカイブ完了

**変更:** <change-name>
**スキーマ:** <schema-name>
**アーカイブ先:** openspec/changes/archive/YYYY-MM-DD-<name>/
**Specs:** ✓ メインspecに同期済み

すべてのアーティファクト完了。すべてのタスク完了。
```

**成功時の出力（デルタspecなし）**

```
## アーカイブ完了

**変更:** <change-name>
**スキーマ:** <schema-name>
**アーカイブ先:** openspec/changes/archive/YYYY-MM-DD-<name>/
**Specs:** デルタspecなし

すべてのアーティファクト完了。すべてのタスク完了。
```

**警告ありの成功時の出力**

```
## アーカイブ完了（警告あり）

**変更:** <change-name>
**スキーマ:** <schema-name>
**アーカイブ先:** openspec/changes/archive/YYYY-MM-DD-<name>/
**Specs:** 同期スキップ（ユーザーがスキップを選択）

**警告:**
- 2件の未完了アーティファクトでアーカイブ
- 3件の未完了タスクでアーカイブ
- デルタspec同期がスキップされた（ユーザーがスキップを選択）

意図しない場合はアーカイブを確認してください。
```

**エラー時の出力（アーカイブが存在）**

```
## アーカイブ失敗

**変更:** <change-name>
**ターゲット:** openspec/changes/archive/YYYY-MM-DD-<name>/

ターゲットアーカイブディレクトリが既に存在します。

**オプション:**
1. 既存アーカイブの名前を変更
2. 重複なら既存アーカイブを削除
3. 別の日付にアーカイブするまで待つ
```

**ガードレール**
- 変更が指定されていない場合は常に選択を促す
- アーティファクトグラフ（openspec status --json）を完了チェックに使用
- 警告でアーカイブをブロックしない - 情報を伝えて確認するだけ
- アーカイブに移動する際.openspec.yamlを保持（ディレクトリと一緒に移動）
- 何が起こったか明確なサマリーを表示
- 同期が要求された場合、/opsx:syncアプローチを使用（エージェント駆動）
- デルタspecsがある場合、常に同期評価を実行しプロンプト前に統合サマリーを表示
