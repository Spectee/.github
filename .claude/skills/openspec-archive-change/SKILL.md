---
name: openspec-archive-change
description: 実験的ワークフローで完了した変更をアーカイブ。ユーザーが実装完了後に変更をファイナライズしてアーカイブしたい場合に使用。
license: MIT
compatibility: openspec CLIが必要。
metadata:
  author: openspec
  version: "1.0"
  generatedBy: "1.0.2"
---

実験的ワークフローで完了した変更をアーカイブします。

**入力**: オプションで変更名を指定。省略した場合は会話のコンテキストから推測を試みます。曖昧または不明確な場合は、利用可能な変更を表示して選択を促す必要があります。

**手順**

1. **変更名が指定されていない場合、選択を促す**

   `openspec list --json`を実行して利用可能な変更を取得。**AskUserQuestionツール**を使用してユーザーに選択させる。

   アクティブな変更のみ表示（アーカイブ済みは除外）。
   各変更で使用されているスキーマが利用可能な場合は表示。

   **重要**: 変更を推測または自動選択しない。常にユーザーに選択させる。

2. **アーティファクトの完了状態を確認**

   `openspec status --change "<name>" --json`を実行してアーティファクトの完了状態を確認。

   JSONをパースして理解：
   - `schemaName`: 使用中のワークフロー
   - `artifacts`: アーティファクトのリストとその状態（`done`またはその他）

   **アーティファクトが`done`でない場合：**
   - 未完了のアーティファクトをリストした警告を表示
   - **AskUserQuestionツール**を使用して続行するか確認
   - ユーザーが確認したら続行

3. **タスクの完了状態を確認**

   タスクファイル（通常`tasks.md`）を読んで未完了タスクを確認。

   `- [ ]`（未完了）と`- [x]`（完了）のタスクをカウント。

   **未完了タスクがある場合：**
   - 未完了タスク数を示す警告を表示
   - **AskUserQuestionツール**を使用して続行するか確認
   - ユーザーが確認したら続行

   **タスクファイルが存在しない場合:** タスク関連の警告なしで続行。

4. **デルタspec同期状態を評価**

   `openspec/changes/<name>/specs/`にデルタspecがあるか確認。ない場合は同期プロンプトなしで続行。

   **デルタspecがある場合：**
   - 各デルタspecを`openspec/specs/<capability>/spec.md`の対応するメインspecと比較
   - どのような変更が適用されるか判断（追加、修正、削除、名前変更）
   - プロンプト前に統合サマリーを表示

   **プロンプトオプション:**
   - 変更が必要な場合：「今すぐ同期（推奨）」、「同期せずにアーカイブ」
   - 既に同期済みの場合：「今すぐアーカイブ」、「とにかく同期」、「キャンセル」

   ユーザーが同期を選択した場合、/opsx:syncロジック（openspec-sync-specsスキルを使用）を実行。選択に関係なくアーカイブに進む。

5. **アーカイブを実行**

   アーカイブディレクトリが存在しない場合は作成：
   ```bash
   mkdir -p openspec/changes/archive
   ```

   現在の日付を使用してターゲット名を生成：`YYYY-MM-DD-<change-name>`

   **ターゲットが既に存在するか確認：**
   - 存在する場合：エラーで失敗し、既存アーカイブの名前変更または別の日付の使用を提案
   - 存在しない場合：変更ディレクトリをアーカイブに移動

   ```bash
   mv openspec/changes/<name> openspec/changes/archive/YYYY-MM-DD-<name>
   ```

6. **サマリーを表示**

   アーカイブ完了サマリーを表示：
   - 変更名
   - 使用されたスキーマ
   - アーカイブ場所
   - specが同期されたかどうか（該当する場合）
   - 警告についての注記（未完了のアーティファクト/タスク）

**成功時の出力**

```
## アーカイブ完了

**変更:** <change-name>
**スキーマ:** <schema-name>
**アーカイブ先:** openspec/changes/archive/YYYY-MM-DD-<name>/
**Specs:** ✓ メインspecsに同期済み（または「デルタspecなし」または「同期スキップ」）

すべてのアーティファクト完了。すべてのタスク完了。
```

**ガードレール**
- 変更名が指定されていない場合は常に選択を促す
- アーティファクトグラフ（openspec status --json）を使用して完了確認
- 警告でアーカイブをブロックしない - 情報を提供して確認のみ
- アーカイブに移動する際に.openspec.yamlを保持（ディレクトリと一緒に移動される）
- 何が起こったかの明確なサマリーを表示
- 同期がリクエストされた場合、openspec-sync-specsアプローチ（エージェント駆動）を使用
- デルタspecが存在する場合、常に同期評価を実行し、プロンプト前に統合サマリーを表示
